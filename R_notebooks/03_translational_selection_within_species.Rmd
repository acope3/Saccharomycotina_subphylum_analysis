---
title: "Evolution of parameters across species"
author: "Alex Cope"
date: '2023-05-04'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ape)
library(phytools)
library(phylogram)
library(cluster)
library(tidyverse)
library(factoextra)
library(dendextend)
library(RColorBrewer)
library(cowplot)
library(reshape2)
library(ggpubr)
library(ggrepel)
library(broom)
library(AnaCoDa)
library(ggtree)
library(patchwork)
library(scales)
library(ComplexHeatmap)
source("helperFunctions.R")



compareHClustToPhylo <- function(phylo.dendro,csp.matrix,hclust.method,title="",...)
{
  cormat <- cor(csp.matrix,use="pairwise.complete.obs",method="spearman")
  hc <- hclust(as.dist(1-cormat),method = hclust.method)
  hc.dendro <- as.dendrogram(hc)
  dend.list <- dendlist(phylo.dendro,hc.dendro)
  corr <- cor.dendlist(dend.list,method="cophenetic")
  
  tanglegram(dend.list,highlight_distinct_edges = FALSE, # Turn-off dashed lines
             common_subtrees_color_lines = FALSE, # Turn-off line colors
             common_subtrees_color_branches = TRUE, # Color common branches
             main_left = paste(title,"\nCorrlelation =", round(corr[1,2], 2)),
             tip_labels_cex = 0
  )
}

leg <- function(){
  plot.new()
  par(margin=c(1,1,1,1))
  legend(x = "topright",legend = unique(clade.colors$Clade), fill=unique(clade.colors$Color),ncol=4,cex=1.5,bty='n')
}




```

# Setup


```{r}
results.dir <- "../Final_runs/Results_k_1/"

all.genomes <- readLines("../Data/all_fungi.txt")
ser.genomes <- readLines("../Data/ser_fungi.txt")
fungi.tree <- read.tree("../Data/tree_with_cds_labels.nwk")
fungi.tree <- cleanTree(fungi.tree,all.genomes)
all.species <- readLines("../Data/all_fungi.txt")

species.dend <- as.dendrogram(fungi.tree)

clades <- read_tsv("../Data/clades.txt")
clades <- clades %>% 
  dplyr::slice(match(fungi.tree$tip.label,file_name_id)) %>%
  dplyr::rename(Species=file_name_id,Clade=Major.clade)


gc.files <- file.path("../Data/GC",all.genomes)
names(gc.files) <- all.genomes
gc.df <- purrr::map(gc.files,read_tsv,col_types = cols()) %>% bind_rows(.id="Species")
gc.df <- gc.df %>% dplyr::rename(GeneID=Gene)

clust.files <- paste0("../Data/Clara_k_2/",all.genomes)
names(clust.files) <- all.genomes
clust.df <- purrr::map(clust.files,read_tsv,col_types = cols()) %>% 
  bind_rows(.id="Species")
clust.df <- clust.df %>% dplyr::rename(GeneID=Gene)

gc.clust.df <- clust.df %>% left_join(gc.df,by=c("Species","GeneID"))

max.cluster <- gc.clust.df  %>% group_by(Species,Cluster) %>% 
               summarize(Median.GC3 = median(GC3)) %>% 
               top_n(1) %>%
               dplyr::rename(Max.Cluster=Cluster) %>%
               dplyr::select(-Median.GC3)

gc.clust.df <- gc.clust.df %>% left_join(max.cluster,by="Species")
gc.clust.df <- gc.clust.df %>% 
              mutate(Cluster = case_when(Cluster == 1 & Max.Cluster == 1 ~ "Higher GC3",
                                         Cluster == 2 & Max.Cluster == 1 ~ "Lower GC3",
                                         Cluster == 1 & Max.Cluster == 2 ~ "Lower GC3",
                                         Cluster == 2 & Max.Cluster == 2 ~ "Higher GC3")
              )

wi <- read_tsv("../Data/cope_wi_with_roc_phi_estimated_weights_2023_05_03_10_restarts_roc_phi_no_cutoff_rel_difference.tsv") %>% 
  dplyr::select(-c(TGG)) %>%
  mutate(across(where(is.numeric),log)) %>%
  dplyr::slice(match(fungi.tree$tip.label,Species))

improved.fits.species <- readLines("../Data/improved_species_by_gene_expression_25_percent_2023_05_03.txt")
compare.emp <- read_csv("../Data/2023-05-04_compare_phi_vs_empirical_k1_vs_k2_roc_fits_all_species.csv")




```



```{r}
deta.matrix.k1 <- read_tsv("../Post_analysis/selection_coefficients_k1.tsv",col_types = cols())
deta.matrix.k2 <- read_tsv("../Post_analysis/selection_coefficients_k2.tsv",col_types = cols())

deta.matrix.k1.rescaled <- read_tsv("../Post_analysis/selection_coefficients_k1_GC_rescaled.tsv",col_types = cols())
deta.matrix.k2.rescaled <- read_tsv("../Post_analysis/selection_coefficients_k2_GC_rescaled.tsv",col_types = cols())

dm.matrix.k1 <- read_tsv("../Post_analysis/mutation_bias_k1.tsv",col_types = cols())
dm.matrix.k2.higher.gc <- read_tsv("../Post_analysis/mutation_bias_k2_higher_GC3.tsv",col_types = cols())
dm.matrix.k2.lower.gc <- read_tsv("../Post_analysis/mutation_bias_k2_lower_GC3.tsv",col_types = cols())

dm.matrix.k1.rescaled <- read_tsv("../Post_analysis/mutation_bias_k1_GC_rescaled.tsv",col_types = cols())
dm.matrix.k2.higher.gc.rescaled <- read_tsv("../Post_analysis/mutation_bias_k2_higher_GC3_GC_rescaled.tsv",col_types = cols())
dm.matrix.k2.lower.gc.rescaled <- read_tsv("../Post_analysis/mutation_bias_k2_lower_GC3_GC_rescaled.tsv",col_types = cols())


```

```{r}
createEmpvsROCdf <- function(target.species,phi,dist.matrix,orthogroups,empirical.data)
{
  dist.from.target <- dist.matrix[,target.species]
  closest.species <- names(dist.from.target[which.min(dist.from.target)])
  
  phi.target <- phi %>% 
    dplyr::select(Orthogroups,!!as.name(target.species)) %>%
    dplyr::rename(Phi = !!as.name(target.species))

  
  ortho.species <- orthogroups %>% 
    dplyr::select(Orthogroups,!!as.name(target.species),!!as.name(closest.species))
  ortho.species <- ortho.species %>% 
    left_join(empirical.data[[closest.species]],
              by=setNames("GeneID",closest.species )
              )
  ortho.species <- ortho.species %>% 
    left_join(phi.target,by="Orthogroups") %>%
    dplyr::select(Orthogroups,Empirical,Phi) %>%
    filter(!is.na(Empirical) & !is.na(Phi)) 
  return(ortho.species)
}

dist.matrix <- cophenetic.phylo(fungi.tree)

species.w.emp <- list.files("../Data/Expression/",full.names = F,pattern=".max.cds")
empirical.data.file <- list.files("../Data/Expression/",full.names = T,include.dirs = F,pattern=".max.cds")
names(empirical.data.file) <- species.w.emp


dist.matrix <- dist.matrix[species.w.emp,]

empirical.data <- purrr::map(empirical.data.file,function(x) {
  read_csv(x,col_types = cols()) %>% 
    mutate(across(contains("tpm_kallisto"),~na_if(., 0))) %>%
    mutate(across(contains("tpm_kallisto"),log)) %>%
    mutate(
      Log.Mean.Expression=rowMeans(dplyr::select(.,contains("tpm_kallisto")),na.rm=T),
      Empirical=exp(Log.Mean.Expression),
      GeneID=str_remove(GeneID,"-mRNA-1")) %>% 
      dplyr::select(-contains("tpm_kallisto"),-Log.Mean.Expression)
    })

phi.df <- read_csv("../Data/phi_shen_etal_ortholog_matrix_2023_05_01.csv",col_types = cols())  %>% 
       column_to_rownames("Orthogroup") %>%
       rename_with(~cleanColumnNames(.x,fungi.tree$tip.label)) %>%
       rownames_to_column("Orthogroups")



orthogroups <- read_tsv("../Data/shen_etal_ortholog_matrix_2021_12_17.tsv",col_types = cols())
orthogroups <- orthogroups %>% 
       column_to_rownames("Orthogroup") %>%
       rename_with(~cleanColumnNames(.x,fungi.tree$tip.label)) %>%
       rownames_to_column("Orthogroups")

names(all.species) <- all.species


roc.emp.df <- lapply(all.species,createEmpvsROCdf,
                      phi = phi.df,
                      dist.matrix = dist.matrix,
                      orthogroups = orthogroups,
                      empirical.data = empirical.data) %>% 
  bind_rows(.id="Species")


write_tsv(roc.emp.df,"../Post_analysis/roc_phi_vs_empirical_for_all_327_yeasts_based_on_shen_etal_2018_one_to_one_orthologs.tsv")



```


### Protein production rates $\phi$

```{r}
getPhi <- function(species,improved.fits.species)
{
  if (species %in% improved.fits.species){
    phi.df <- read_csv(file.path("../Final_runs/Results_k_2_selectionShared/",species,"run_2/Parameter_est/gene_expression.txt"),col_types = cols()) 
  } else{
    phi.df <- read_csv(file.path("../Final_runs/Results_k_1/",species,"run_2/Parameter_est/gene_expression.txt"),col_types = cols()) 
  }
  return(phi.df)
}


species <- list.dirs(file.path("../Final_runs/Results_k_2_selectionShared/"),full.names = F,recursive = F)
names(species) <- species

phi.df <- purrr::map(species,getPhi,improved.fits.species) %>% 
  bind_rows(.id="Species")

phi.summary <- phi.df %>% 
  group_by(Species) %>%
  summarize(Mean.Phi = mean(Mean),
            Sd.Phi = sd(Mean.log10),
            Total = n(),
            )

mean.phi.dist <- ggplot(phi.summary,aes(x=Mean.Phi)) + 
  geom_histogram(fill="white",color="black") +
  theme_cowplot() +
  ggtitle("Distribution of mean gene expression estimate across species")
mean.phi.dist



```


```{r,echo=F}

phi <- read_csv("../Data/phi_shen_etal_ortholog_matrix_2023_05_01.csv")
phi <- phi %>% column_to_rownames("Orthogroup") %>%
       rename_with(~cleanColumnNames(.x,fungi.tree$tip.label))
phi <- phi[,fungi.tree$tip.label]
phi.log <- as.data.frame(phi) %>% 
  mutate(across(where(is.numeric),log)) %>%
  as.matrix()


```


# Create final parameter matrices dependent on improved species fits 

```{r}
deta.matrix <- deta.matrix.k1
deta.matrix <- deta.matrix %>% 
  column_to_rownames("Species")
deta.matrix <- as.data.frame(t(deta.matrix))

dm.matrix <- dm.matrix.k1
dm.matrix <- dm.matrix %>% 
  column_to_rownames("Species")
dm.matrix <- as.data.frame(t(dm.matrix))


deta.matrix.gc <- deta.matrix.k1.rescaled
deta.matrix.gc <- deta.matrix.gc %>% 
  column_to_rownames("Species")
deta.matrix.gc <- as.data.frame(t(deta.matrix.gc))

dm.matrix.gc <- dm.matrix.k1.rescaled
dm.matrix.gc <- dm.matrix.gc %>% 
  column_to_rownames("Species")
dm.matrix.gc <- as.data.frame(t(dm.matrix.gc))



for (i in improved.fits.species)
{
  deta.matrix <- deta.matrix %>%
    mutate(!!as.name(i) := deta.matrix.k2 %>% 
            filter(Species == i) %>% 
            dplyr::select(-Species) %>%
            unlist()
    )
  deta.matrix.gc <- deta.matrix.gc %>% 
    mutate(!!as.name(i) := deta.matrix.k2.rescaled %>% 
            filter(Species == i) %>% 
            dplyr::select(-Species) %>%
            unlist()
    )
  
  dm.matrix <- dm.matrix %>% 
    mutate(!!as.name(i) := dm.matrix.k2.higher.gc%>% 
            filter(Species == i) %>% 
            dplyr::select(-Species) %>%
            unlist(),
           !!as.name(paste0(i,"_Lower_GC3")) := dm.matrix.k2.lower.gc %>% 
            filter(Species == i) %>% 
            dplyr::select(-Species) %>%
            unlist()
    ) %>%
      dplyr::rename(!!as.name(paste0(i,"_Higher_GC3")) := !!as.name(i))
  
  dm.matrix.gc <- dm.matrix.gc %>% 
    mutate(!!as.name(i) := dm.matrix.k2.higher.gc.rescaled%>% 
            filter(Species == i) %>% 
            dplyr::select(-Species) %>%
            unlist(),
           !!as.name(paste0(i,"_Lower_GC3")) := dm.matrix.k2.lower.gc.rescaled %>% 
            filter(Species == i) %>% 
            dplyr::select(-Species) %>%
            unlist()
    ) %>%
      dplyr::rename(!!as.name(paste0(i,"_Higher_GC3")) := !!as.name(i))
}

param.list <- list(deta.matrix,deta.matrix.gc,dm.matrix,dm.matrix.gc) %>%
  purrr::map(~.x %>%
              t() %>% 
              as.data.frame() %>%
              rownames_to_column("Species") %>%
              as_tibble())

deta.matrix <- param.list[[1]]
deta.matrix.gc <- param.list[[2]]
dm.matrix <- param.list[[3]]
dm.matrix.gc <- param.list[[4]]


```

# Waiting time across species

```{r fig.height=7,fig.width=12}

raw.weights <- read_tsv("../Data/cope_unnormalized_wi_with_roc_phi_estimated_weights_2023_05_03_10_restarts_roc_phi_no_cutoff_rel_difference.tsv") %>% 
  dplyr::select(-c(TGG)) %>%
  mutate(across(where(is.numeric),log)) %>%
  dplyr::slice(match(fungi.tree$tip.label,Species))

label.order <- fungi.tree$tip.label

clades <- clades %>% 
  filter(Species %in% label.order) %>%
  dplyr::slice(match(label.order, Species))
  
col.map <- colormap::colormap(colormap::colormaps$rainbow,
                                                    nshades=length(unique(unlist(clades[,"Clade"]))))
names(col.map) <- unlist(unique(clades$Clade))
clade_annot <- rowAnnotation(Clade = clades$Clade,
                           col = list(Clade = col.map))

tai.matrix.for.heatmap <- raw.weights %>%
  mutate(across(where(is.numeric), ~na_if(., Inf)), 
         across(where(is.numeric), ~na_if(., -Inf)),
         #across(where(is.numeric), ~na_if(.,0))  
         ) %>% 
  left_join(clades)
tai.matrix.for.heatmap <- tai.matrix.for.heatmap %>%
  dplyr::select(-Clade) %>%
  dplyr::slice(match(fungi.tree$tip.label,Species)) %>%
  column_to_rownames("Species") %>% 
  as.matrix()
tai.phylo.hm <- Heatmap(tai.matrix.for.heatmap,
        na_col = "black",
        cluster_rows = as.dendrogram(fungi.tree),
        name = "Unnormalized tAI weights",
        left_annotation = clade_annot,
        show_row_names = F)

tai.phylo.hm


cairo_pdf("../Figures/All_species/unnormalized_tai_weights_heatmap_phylogeny.pdf",width=12,height=7,family = "Arial Unicode MS")
draw(tai.phylo.hm)
dev.off()


```






# Compare selection coefficients and waiting times within each species

```{r fig.height=9,fig.width=9, warning = F}
wi <- wi[,colnames(deta.matrix)]

deta.matrix.long <- deta.matrix %>%
  pivot_longer(-Species,names_to="Codon",values_to="Selection")

wi.matrix.long <- wi %>% 
  pivot_longer(-Species,names_to="Codon",values_to="tAI") %>%
  mutate(tAI = ifelse(is.finite(tAI),tAI,NA))

deta.wi.matrix.long <- deta.matrix.long %>% 
  inner_join(wi.matrix.long,by=c("Species","Codon")) %>%
  left_join(clades,by="Species")

write_tsv(deta.wi.matrix.long,"../Post_analysis/roc_sel_coef_vs_tAI_for_all_327_yeasts.tsv")

cor.df.tai <- deta.wi.matrix.long %>% 
  group_by(Species) %>%
  nest(Codon,Selection,tAI) %>% 
  mutate(corr.tai = purrr::map(data,~cor.test(.x$tAI,.x$Selection,method="spearman",use="complete.obs",alternative="greater") %>% tidy())
         ) %>% 
  dplyr::select(-data) %>% 
  unnest(starts_with("corr"),names_sep = "_") 

cor.df.tai <- cor.df.tai %>% 
  ungroup() %>% 
  mutate(corr.tai_p.value.adjusted = p.adjust(corr.tai_p.value,method = "BH"))

tree.plot <- ggtree(fungi.tree)

tai.phylo <- treeTraitPlot(tree.plot,cor.df.tai,"corr.tai_estimate",significance="corr.tai_p.value",panel.name = "Spearman Correlation\nSelection Coefficients vs. Waiting Times")

total.plot <- tai.phylo + 
  theme_tree2() +
  theme(legend.title = element_text(size=16),
        legend.text = element_text(size=14))
  #ggtitle("Selection coefficients reflect translational selection\nacross the Saccharomycotina subphylum")
total.plot

```


```{r}
compare.emp.tai <- compare.emp %>% 
  left_join(cor.df.tai,by=c("Species","Clade"))
compare.emp.tai <- compare.emp.tai %>% 
  dplyr::slice(match(fungi.tree$tip.label,Species))


p <- ggplot(compare.emp.tai,aes(x=estimate_Phi,y=corr.tai_estimate)) +
  geom_point(aes(color=Clade)) +
  stat_cor(method="spearman",label.sep="\n") +
  xlab("Spearman Correlation\nPhi vs. Empirical") +
  ylab("Spearman Correlation\nSelection vs. tAI") +
  geom_hline(yintercept=0,linetype="dashed") +
  geom_vline(xintercept=0,linetype="dashed") +
  theme_cowplot() +
  theme(aspect.ratio=1)
  

p


compare.emp.tai <- compare.emp.tai %>% 
  dplyr::select(Species,estimate_Phi,corr.tai_estimate) %>% 
  dplyr::rename(Corr.Gene.Exp.vs.Phi = estimate_Phi, 
                Corr.tAI.vs.Sel.Coef = corr.tai_estimate
                )

write_tsv(compare.emp.tai,"../Post_analysis/within_species_correlaitons_gene_expression_vs_phi_and_tAI_vs_sel_coeff.tsv")


```


```{r,fig.height=5,fig.width=10}
calb.selection <- deta.wi.matrix.long %>% 
  filter(Species == "candida_albicans.max.cds")

calb.waiting.times <- ggplot(calb.selection,aes(x=tAI,y=Selection)) +
     geom_point() +
     stat_cor(method="spearman",label.sep = "\n",alternative="greater") +
     xlab("Waiting Time") +
     ylab("Selection Coefficient") +
     ggtitle("C. albicans") +
     theme_cowplot()
     
calb.waiting.times

sameth.selection <- deta.wi.matrix.long %>% 
  filter(Species == "yHMPu5000035658_starmera_amethionina_160613.max.cds")

sameth.waiting.times <- ggplot(sameth.selection,aes(x=tAI,y=Selection)) +
     geom_point() +
     stat_cor(method="spearman",label.sep = "\n",alternative="greater") +
     xlab("Waiting Time") +
     ylab("Selection Coefficient") +
     ggtitle("S. amethionina") +
     theme_cowplot()
     
sameth.waiting.times

layout<-"
AACCCC
AACCCC
BBCCCC
BBCCCC
"
sel.vs.trna <- calb.waiting.times + sameth.waiting.times + total.plot + plot_annotation(tag_level="A") + plot_layout(design = layout)

sel.vs.trna

savePlot("../Figures/All_species/02_intraspecies_sel_coef_wait_time.pdf",plot = sel.vs.trna,height=10,width=14)



```



```{r echo = F, fig.width=9,fig.height=9,warning=F}
plotSelectionAndTAI <- function(codon.df,tree)
{
  codon.df <- codon.df %>% 
    dplyr::slice(match(tree$tip.label,Species))
  tree.plot <- ggtree(tree)

  tree.plot <- treeTraitPlot(tree.plot,codon.df,"tAI",significance=NULL,panel.name = "tAI")
  tree.plot <- treeTraitPlot(tree.plot,codon.df,"Selection",significance=NULL,panel.name = "Selection Coefficient")
  total.plot <- tree.plot + 
    theme_tree2() +
    theme(legend.title = element_text(size=16),legend.text = element_text(size=14)) +
    ggtitle(unique(codon.df$Codon))
  total.plot
}

deta.wi.matrix.long.split <- deta.wi.matrix.long %>% 
  group_by(Codon) %>%
  group_split()

lapply(deta.wi.matrix.long.split,plotSelectionAndTAI,tree=fungi.tree)
```



```{r echo = F,warning=F,fig.width=16,fig.height=16}

codon.selection.long <-deta.wi.matrix.long %>%
  pivot_longer(c(Selection,tAI),names_to="Parameter",values_to="Estimate")

codon.dist <- ggplot(codon.selection.long,aes(x=Estimate,fill=Parameter)) +
  geom_histogram(position = "identity",color="black",alpha=0.5) +
  geom_vline(xintercept = 0,linetype="solid",color="black") +
  theme_cowplot() +
  theme(aspect.ratio=1) +
  ggtitle("Distribution of selection coefficients and tAI") +
  ylab("Count") +
  facet_wrap(~Codon,scales = "free")
codon.dist

savePlot("../Figures/All_species/S04_selection_and_tai_distributions.pdf",plot=codon.dist,height=16,width=16)

```



